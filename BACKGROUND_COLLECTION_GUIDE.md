# 백그라운드 수집 동작 가이드

## 🔍 현재 동작 방식

### ✅ 사이트 접속 없이도 수집 가능한가?

**부분적으로 가능합니다.** 하지만 제한사항이 있습니다:

1. **Service Worker의 제한사항**
   - Service Worker는 브라우저가 완전히 종료되면 **일시 중단**됩니다
   - 브라우저가 백그라운드에서 실행 중일 때만 작동합니다
   - 모바일에서는 더 제한적입니다 (배터리 절약 모드 등)

2. **현재 구현 상태**
   - 브라우저가 열려있고 (탭이 닫혀도 됨) 백그라운드에서 실행 중일 때 작동
   - 30초마다 자동으로 배치 실행
   - 네트워크 에러 시 2분 후 자동 재시도

## ⚠️ 중단 시나리오 및 대응

### 1. 브라우저 완전 종료
**상황**: 사용자가 브라우저를 완전히 종료
**결과**: Service Worker가 중단됨
**대응**: 
- 사이트 재접속 시 Service Worker가 자동으로 재시작
- 하지만 **이전 상태(processedCount 등)가 초기화됨**
- 수집된 키워드는 DB에 저장되어 있으므로 손실 없음

### 2. 네트워크 끊김
**상황**: 인터넷 연결이 끊김
**결과**: API 호출 실패
**대응**: 
- 현재 코드: 2분 후 자동 재시도
- 네트워크 복구 시 자동으로 재개

### 3. Service Worker 업데이트
**상황**: 새 버전 배포로 Service Worker 업데이트
**결과**: 기존 Service Worker가 중단되고 새 버전으로 교체
**대응**: 
- `skipWaiting()`으로 즉시 활성화
- 하지만 **이전 상태가 초기화됨**

### 4. 타임아웃 연속 발생
**상황**: 연속 5회 타임아웃 발생
**결과**: 자동 수집 일시 중단
**대응**: 
- 수동으로 재시작 필요
- 또는 사이트 재접속 시 자동 재시작 (설정이 localStorage에 저장되어 있으면)

## 🔧 현재 코드의 한계점

1. **상태 저장 부족**
   - `processedCount`, `totalNewKeywordsAccumulated` 등이 메모리에만 저장
   - 브라우저 종료 시 상태 손실

2. **복구 메커니즘 부족**
   - 브라우저 재시작 시 이전 상태 복구 불가
   - 수동으로 재시작해야 함

3. **Background Sync 미사용**
   - Background Sync API를 사용하면 더 안정적인 백그라운드 실행 가능

## 💡 개선 방안

### 1. 상태 영구 저장 (IndexedDB)
- `processedCount`, `totalNewKeywordsAccumulated` 등을 IndexedDB에 저장
- 브라우저 재시작 시 상태 복구

### 2. Background Sync API 활용
- 브라우저가 완전히 종료되어도 복구 시 자동 재시작
- 네트워크 복구 시 자동 동기화

### 3. Cloudflare Scheduled Functions (Cron)
- 서버 측에서 주기적으로 실행
- 브라우저와 무관하게 24시간 실행 가능
- 가장 안정적인 방법

## 📊 현재 상태 확인 방법

### 브라우저가 열려있는 경우
1. 사이트 접속: https://0-nkey.pages.dev/auto-collect
2. 콘솔 로그 확인: `[SW] 백그라운드 실행 중` 메시지 확인
3. 상태 확인: 페이지에서 "Service Worker 상태 확인" 버튼 클릭

### 브라우저가 닫혀있는 경우
- **확인 불가능**: Service Worker가 중단되었을 가능성이 높음
- 사이트 재접속 시 자동 재시작 여부 확인

## 🎯 권장 사용 방법

### 최적의 사용법
1. **브라우저를 열어두기**: 백그라운드에서 계속 실행되도록
2. **탭은 닫아도 됨**: Service Worker는 탭이 닫혀도 작동
3. **브라우저는 종료하지 않기**: 완전 종료 시 Service Worker 중단
4. **네트워크 연결 유지**: 인터넷 연결이 필요

### 대안: Cloudflare Cron 사용
- 서버 측에서 실행되므로 브라우저와 무관
- 24시간 안정적으로 실행
- 현재 구현되어 있음: `functions/_cron/auto-collect.ts`

## ⚙️ 현재 설정 확인

현재 코드에서:
- **배치 간격**: 30초
- **네트워크 에러 재시도**: 2분 후
- **타임아웃 허용**: 연속 5회까지
- **상태 저장**: 메모리만 (브라우저 종료 시 손실)

## 🔄 상태 복구 개선 필요

현재는 브라우저 재시작 시 상태가 초기화되지만, 수집된 키워드는 DB에 저장되어 있어 손실은 없습니다. 다만 진행 상황(processedCount)은 초기화됩니다.

