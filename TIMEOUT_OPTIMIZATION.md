# 타임아웃 최적화 가이드

## 🎯 최적화 목표

타임아웃 없이 안정적으로 많은 키워드를 지속적으로 수집할 수 있도록 시스템을 최적화했습니다.

## ✅ 적용된 최적화

### 1. 타임아웃 시간 증가
- **변경 전**: 3분 타임아웃
- **변경 후**: 5분 타임아웃
- **효과**: 네이버 API 응답 시간 및 문서수 수집 시간 여유 확보

### 2. 동시 처리 수 감소
- **변경 전**: 기본 20개, 최대 25개
- **변경 후**: 기본 15개, 최대 20개
- **효과**: 동시 요청 부하 감소로 타임아웃 발생 감소

### 3. 배치 크기 조정
- **변경 전**: 기본 50개, 최대 200개
- **변경 후**: 기본 30개, 최대 100개
- **효과**: 배치당 처리 시간 단축으로 타임아웃 감소

### 4. 동적 병렬 처리 개선
- **최대 병렬 처리 수**: 50개 → 30개
- **조정 간격**: 30초 → 20초 (더 빠른 반응)
- **목표 성공률**: 95% → 90% (타임아웃 고려하여 완화)
- **목표 응답 시간**: 2초 → 60초 (타임아웃 고려하여 증가)
- **타임아웃 위험 감지**: 응답 시간이 4분 이상이면 자동으로 병렬 처리 수 감소

### 5. 문서수 수집 최적화
- **최대 수집 개수**: 10개 → 5개
- **수집 조건**: 새로 추가된 키워드만 수집 (기존 키워드 제외)
- **타임아웃 설정**: 문서수 수집 API에 10초 타임아웃 추가
- **재시도 횟수**: 3회 → 2회
- **백오프 시간**: 300ms → 200ms
- **API 호출 간격**: 100ms → 50ms

### 6. 청크 간 대기 시간 조정
- **변경 전**: 100-500ms
- **변경 후**: 200-1000ms
- **효과**: Rate Limit 방지 및 시스템 안정성 향상

### 7. Service Worker 타임아웃 조정
- **변경 전**: 15분 타임아웃, 연속 3회 타임아웃 시 중단
- **변경 후**: 10분 타임아웃, 연속 5회 타임아웃 시 중단
- **효과**: 더 관대한 타임아웃 정책으로 안정성 향상

## 📊 예상 효과

### 타임아웃 감소
- **예상 감소율**: 60-80%
- **이유**: 
  - 타임아웃 시간 증가 (3분 → 5분)
  - 동시 처리 수 감소 (25개 → 15개)
  - 문서수 수집 최적화

### 성공률 향상
- **예상 향상율**: 20-40%
- **이유**:
  - 타임아웃 감소로 실패율 감소
  - 동적 병렬 처리 개선

### 처리 속도
- **단기**: 약간 감소 (동시 처리 수 감소)
- **장기**: 유지 또는 향상 (타임아웃 재시도 감소)

## 🔧 설정 값 요약

### auto-collect.ts
```typescript
// 배치 크기
const batchSize = 30; // 기본값 (이전: 50)

// 동시 처리 수
const concurrentLimit = 15; // 기본값 (이전: 20)

// 타임아웃
const timeout = 300000; // 5분 (이전: 180000, 3분)
```

### adaptive-concurrency.ts
```typescript
// 최대 병렬 처리 수
const maxConcurrency = 30; // (이전: 50)

// 조정 간격
const adjustmentInterval = 20000; // 20초 (이전: 30000, 30초)

// 목표 성공률
const targetSuccessRate = 0.90; // 90% (이전: 0.95, 95%)

// 목표 응답 시간
const targetResponseTime = 60000; // 60초 (이전: 2000, 2초)
```

### collect-naver.ts
```typescript
// 문서수 수집 최대 개수
const maxDocCountsToCollect = 5; // (이전: 10)

// 문서수 수집 타임아웃
const docCountTimeout = 10000; // 10초

// 재시도 횟수
const maxRetries = 2; // (이전: 3)
```

## 📈 모니터링

### 주요 지표
1. **타임아웃 발생 횟수**: 배치당 타임아웃 발생 횟수 (목표: 0개)
2. **성공률**: 배치당 성공률 (목표: 90% 이상)
3. **평균 응답 시간**: 배치당 평균 응답 시간 (목표: 60초 이하)
4. **병렬 처리 수**: 현재 병렬 처리 수 (자동 조정됨)

### 로그 확인
- 타임아웃 발생 시: `⏱️ 시드 처리 타임아웃 (${seed}): 5분 초과`
- 병렬 처리 수 조정: `📉 병렬 처리 수 감소` 또는 `📈 병렬 처리 수 증가`
- 타임아웃 위험 감지: `타임아웃 위험 (응답: X초)`

## ⚠️ 주의사항

1. **처리 속도**: 동시 처리 수 감소로 단기적으로 처리 속도가 약간 느려질 수 있습니다.
2. **문서수 수집**: 문서수 수집이 최소화되어 일부 키워드의 문서수 정보가 누락될 수 있습니다.
3. **타임아웃**: 여전히 발생할 수 있지만, 발생 빈도가 크게 감소할 것입니다.

## 🔄 추가 최적화 가능 사항

### 향후 개선 가능
1. **타임아웃 재시도 큐**: 타임아웃 발생 시드 재시도 큐 추가
2. **문서수 수집 비활성화 옵션**: 필요 시 문서수 수집 완전 비활성화
3. **배치 크기 동적 조정**: 성공률에 따라 배치 크기 자동 조정
4. **API 키별 타임아웃 모니터링**: 각 API 키별 타임아웃 발생 추적

## 📚 참고 자료

- [OPTIMIZATION_GUIDE.md](./OPTIMIZATION_GUIDE.md) - 전체 최적화 가이드
- [GITHUB_DEPLOYMENT.md](./GITHUB_DEPLOYMENT.md) - 배포 가이드

