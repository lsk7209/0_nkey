[1mdiff --cc functions/api/auto-collect.ts[m
[1mindex c7bb22e,38b272d..0000000[m
[1m--- a/functions/api/auto-collect.ts[m
[1m+++ b/functions/api/auto-collect.ts[m
[36m@@@ -53,26 -70,75 +70,77 @@@[m [mexport async function onRequest(context[m
        LIMIT ?[m
      `;[m
      [m
[31m -    // ë””ë²„ê¹…: ì‹œë“œ ì¡°íšŒ ì „ ë‚¨ì€ ì‹œë“œ ìˆ˜ í™•ì¸[m
[31m -    const debugRemainingQuery = `[m
[31m -      SELECT COUNT(1) as count[m
[31m -      FROM keywords k[m
[31m -      LEFT JOIN auto_seed_usage a ON a.seed = k.keyword[m
[31m -      WHERE a.seed IS NULL[m
[31m -    `;[m
[31m -    const debugRemaining = await db.prepare(debugRemainingQuery).all();[m
[31m -    const debugRemainingCount = debugRemaining.results?.[0]?.count ?? 0;[m
[31m -    console.log(`ğŸ” ì‹œë“œ ì¡°íšŒ ì „ ë‚¨ì€ ì‹œë“œ ìˆ˜: ${debugRemainingCount.toLocaleString()}ê°œ`);[m
[32m +    // ë””ë²„ê¹…: ì‹œë“œ ì¡°íšŒ ì „ ë‚¨ì€ ì‹œë“œ ìˆ˜ í™•ì¸ (í”„ë¡œë•ì…˜ì—ì„œëŠ” ìµœì†Œí™”)[m
[32m +    if (process.env.NODE_ENV === 'development') {[m
[32m +      const debugRemainingQuery = `[m
[32m +        SELECT COUNT(1) as count[m
[32m +        FROM keywords k[m
[32m +        LEFT JOIN auto_seed_usage a ON a.seed = k.keyword[m
[32m +        WHERE a.seed IS NULL[m
[32m +      `;[m
[32m +      const debugRemaining = await db.prepare(debugRemainingQuery).all();[m
[32m +      const debugRemainingCount = debugRemaining.results?.[0]?.count ?? 0;[m
[32m +      console.log(`ğŸ” ì‹œë“œ ì¡°íšŒ ì „ ë‚¨ì€ ì‹œë“œ ìˆ˜: ${debugRemainingCount.toLocaleString()}ê°œ`);[m
[32m +    }[m
  [m
      const take = unlimited ? 50 : Math.max(1, Math.min(batchSize, 200)); // ìµœëŒ€ 200ê°œê¹Œì§€ ì²˜ë¦¬ ê°€ëŠ¥ (5ê°œ API í‚¤ í™œìš©)[m
[31m-     const seeds = await db.prepare(seedsQuery).bind(take).all();[m
[31m-     const seedRows = seeds.results || [];[m
[32m+     let seeds = await db.prepare(unusedSeedsQuery).bind(take).all();[m
[32m+     let seedRows = seeds.results || [];[m
[32m+ [m
[32m+     // ë¯¸ì‚¬ìš© ì‹œë“œê°€ ì—†ìœ¼ë©´ ì˜¤ë˜ ì „ì— ì‚¬ìš©ëœ ì‹œë“œ ì¬ì‚¬ìš© (24ì‹œê°„ ë¬´í•œ ìˆ˜ì§‘ ëª¨ë“œ)[m
[32m+     if (seedRows.length === 0) {[m
[32m+       console.log(`âš ï¸ ë¯¸ì‚¬ìš© ì‹œë“œê°€ ì—†ìŠµë‹ˆë‹¤. ì˜¤ë˜ ì „ì— ì‚¬ìš©ëœ ì‹œë“œë¥¼ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤...`);[m
[32m+       [m
[32m+       // 30ì¼ ì´ìƒ ì „ì— ì‚¬ìš©ë˜ì—ˆê±°ë‚˜ ì‚¬ìš© íšŸìˆ˜ê°€ ì ì€ ì‹œë“œ ì¬ì‚¬ìš©[m
[32m+       const reusedSeedsQuery = `[m
[32m+         SELECT k.id, k.keyword[m
[32m+         FROM keywords k[m
[32m+         INNER JOIN auto_seed_usage a ON a.seed = k.keyword[m
[32m+         WHERE a.last_used < datetime('now', '-30 days') [m
[32m+            OR a.usage_count <= 2[m
[32m+         ORDER BY a.last_used ASC, a.usage_count ASC, k.avg_monthly_search DESC[m
[32m+         LIMIT ?[m
[32m+       `;[m
[32m+       [m
[32m+       seeds = await db.prepare(reusedSeedsQuery).bind(take).all();[m
[32m+       seedRows = seeds.results || [];[m
[32m+       [m
[32m+       if (seedRows.length > 0) {[m
[32m+         console.log(`âœ… ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œë“œ ${seedRows.length}ê°œ ë°œê²¬ (30ì¼ ì´ìƒ ì „ ì‚¬ìš© ë˜ëŠ” ì‚¬ìš© íšŸìˆ˜ 2íšŒ ì´í•˜)`);[m
[32m+       } else {[m
[32m+         // ê·¸ë˜ë„ ì—†ìœ¼ë©´ ê°€ì¥ ì˜¤ë˜ ì „ì— ì‚¬ìš©ëœ ì‹œë“œ ì¬ì‚¬ìš©[m
[32m+         const oldestSeedsQuery = `[m
[32m+           SELECT k.id, k.keyword[m
[32m+           FROM keywords k[m
[32m+           INNER JOIN auto_seed_usage a ON a.seed = k.keyword[m
[32m+           ORDER BY a.last_used ASC, a.usage_count ASC, k.avg_monthly_search DESC[m
[32m+           LIMIT ?[m
[32m+         `;[m
[32m+         [m
[32m+         seeds = await db.prepare(oldestSeedsQuery).bind(take).all();[m
[32m+         seedRows = seeds.results || [];[m
[32m+         [m
[32m+         if (seedRows.length > 0) {[m
[32m+           console.log(`âœ… ê°€ì¥ ì˜¤ë˜ ì „ì— ì‚¬ìš©ëœ ì‹œë“œ ${seedRows.length}ê°œ ì¬ì‚¬ìš© (24ì‹œê°„ ë¬´í•œ ìˆ˜ì§‘ ëª¨ë“œ)`);[m
[32m+         }[m
[32m+       }[m
[32m+     }[m
  [m
      if (seedRows.length === 0) {[m
[32m+       // ì •ë§ í‚¤ì›Œë“œê°€ í•˜ë‚˜ë„ ì—†ëŠ” ê²½ìš°ë§Œ ì—ëŸ¬ ë°˜í™˜[m
[32m+       const totalKeywordsCheck = await db.prepare('SELECT COUNT(*) as total FROM keywords').all();[m
[32m+       const totalKeywordsCount = totalKeywordsCheck.results?.[0]?.total ?? 0;[m
[32m+       [m
[32m+       if (totalKeywordsCount === 0) {[m
[32m+         return new Response([m
[32m+           JSON.stringify({ success: false, processed: 0, remaining: 0, message: 'í‚¤ì›Œë“œê°€ í•˜ë‚˜ë„ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í‚¤ì›Œë“œë¥¼ ìˆ˜ì§‘í•´ì£¼ì„¸ìš”.' }),[m
[32m+           { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }[m
[32m+         );[m
[32m+       }[m
[32m+       [m
[32m+       // í‚¤ì›Œë“œëŠ” ìˆì§€ë§Œ ì‹œë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš° (ë°ì´í„° ì •í•©ì„± ë¬¸ì œ)[m
        return new Response([m
[31m-         JSON.stringify({ success: true, processed: 0, remaining: 0, message: 'í™œìš© ê°€ëŠ¥í•œ ì‹œë“œê°€ ì—†ìŠµë‹ˆë‹¤.' }),[m
[32m+         JSON.stringify({ success: true, processed: 0, remaining: 0, message: 'ì‹œë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.' }),[m
          { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }[m
        );[m
      }[m
[36m@@@ -98,8 -169,17 +171,20 @@@[m
      }[m
  [m
        for (const chunk of chunks) {[m
[32m++<<<<<<< HEAD[m
[32m++=======[m
[32m+         console.log(`ğŸ”„ ì²­í¬ ì²˜ë¦¬ ì‹œì‘: ${chunk.length}ê°œ ì‹œë“œ ë™ì‹œ ì²˜ë¦¬ (ë™ì  ë³‘ë ¬: ${effectiveConcurrency}ê°œ, ì‹œë“œ ëª©ë¡: ${chunk.map((r: any) => r.keyword).join(', ')})`);[m
[32m++>>>>>>> e952aa8 (feat: ìë™ ìˆ˜ì§‘ ìµœì í™” ë° GitHub ìë™ ë°°í¬ ì„¤ì •)[m
          totalAttempted += chunk.length;[m
  [m
[32m+         // Circuit Breaker ìƒíƒœ í™•ì¸[m
[32m+         if (circuitBreaker.getState() === CircuitState.OPEN) {[m
[32m+           console.warn('âš ï¸ Circuit Breaker OPEN: ì¼ì‹œì ìœ¼ë¡œ ìš”ì²­ ì°¨ë‹¨ ì¤‘');[m
[32m+           // ì°¨ë‹¨ ì¤‘ì´ë©´ ì§§ì€ ëŒ€ê¸° í›„ ê³„ì† (ë‹¤ìŒ ì²­í¬ì—ì„œ ì¬ì‹œë„)[m
[32m+           await new Promise(r => setTimeout(r, 1000));[m
[32m+           continue;[m
[32m+         }[m
[32m+ [m
        // ì²­í¬ ë‚´ ì‹œë“œë“¤ì„ ë³‘ë ¬ë¡œ ì²˜ë¦¬[m
        const chunkPromises = chunk.map(async (row: any) => {[m
          const seed: string = row.keyword;[m
[36m@@@ -127,6 -229,17 +234,20 @@@[m
                  const totalCollected = collectResult.totalCollected || 0;[m
                  const totalSavedOrUpdated = collectResult.totalSavedOrUpdated || 0;[m
                  [m
[32m++<<<<<<< HEAD[m
[32m++=======[m
[32m+                 // API í‚¤ ì‚¬ìš©ëŸ‰ ê¸°ë¡ (ì„±ê³µ)[m
[32m+                 apiKeyManager.recordCall(selectedKeyIndex, true, responseTime, false);[m
[32m+                 // ë™ì  ë³‘ë ¬ ì²˜ë¦¬ í†µê³„ ê¸°ë¡ (ì„±ê³µ)[m
[32m+                 adaptiveConcurrency.recordRequest(true, responseTime);[m
[32m+                 [m
[32m+                 // ìƒì„¸ ë¡œê¹… (ë””ë²„ê¹…ìš©)[m
[32m+                 if (savedCount === 0 && totalCollected === 0) {[m
[32m+                   console.log(`âš ï¸ ì‹œë“œ "${seed}" ì²˜ë¦¬ ì™„ë£Œí–ˆì§€ë§Œ í‚¤ì›Œë“œ ìˆ˜ì§‘ ì—†ìŒ (ì´ë¯¸ ìˆ˜ì§‘ë˜ì—ˆê±°ë‚˜ í‚¤ì›Œë“œ ì—†ìŒ)`);[m
[32m+                 } else {[m
[32m+                   console.log(`âœ… ì‹œë“œ "${seed}" ì²˜ë¦¬ ì„±ê³µ: ìˆ˜ì§‘ ${totalCollected}ê°œ, ì €ì¥ ${savedCount}ê°œ (ì‹ ê·œ), ì—…ë°ì´íŠ¸ ${totalSavedOrUpdated - savedCount}ê°œ (í‚¤: ${selectedKeyIndex + 1}, ì‘ë‹µ: ${responseTime}ms)`);[m
[32m+                 }[m
[32m++>>>>>>> e952aa8 (feat: ìë™ ìˆ˜ì§‘ ìµœì í™” ë° GitHub ìë™ ë°°í¬ ì„¤ì •)[m
                  [m
                  return {[m
                    seed,[m
[36m@@@ -136,18 -249,49 +257,60 @@@[m
                    savedCount // ìƒˆë¡œ ì¶”ê°€ëœ í‚¤ì›Œë“œ ìˆ˜[m
                  };[m
                } else {[m
[32m++<<<<<<< HEAD[m
[32m +                const errorMessage = collectResult.error || collectResult.message || 'Unknown error';[m
[32m +                return { seed, success: false, totalCollected: 0, totalSavedOrUpdated: 0, savedCount: 0, error: errorMessage };[m
[32m +              }[m
[32m +            } else {[m
[32m++=======[m
[32m+                 // collect-naver APIê°€ ì‹¤íŒ¨í•œ ê²½ìš°[m
[32m+                 const errorMessage = collectResult.error || collectResult.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';[m
[32m+                 console.warn(`âš ï¸ ì‹œë“œ "${seed}" collect-naver API ì‹¤íŒ¨: ${errorMessage}`);[m
[32m+                 [m
[32m+                 // API í‚¤ ì‚¬ìš©ëŸ‰ ê¸°ë¡ (ì‹¤íŒ¨)[m
[32m+                 apiKeyManager.recordCall(selectedKeyIndex, false, responseTime, false);[m
[32m+                 // ë™ì  ë³‘ë ¬ ì²˜ë¦¬ í†µê³„ ê¸°ë¡ (ì‹¤íŒ¨)[m
[32m+                 adaptiveConcurrency.recordRequest(false, responseTime);[m
[32m+                 [m
[32m+                 return { seed, success: false, totalCollected: 0, totalSavedOrUpdated: 0, savedCount: 0, error: errorMessage };[m
[32m+               }[m
[32m+             } else {[m
[32m+               // HTTP ì‘ë‹µì´ ì‹¤íŒ¨í•œ ê²½ìš°[m
[32m+               const errorText = await res.text().catch(() => '');[m
[32m+               console.error(`âŒ ì‹œë“œ "${seed}" HTTP ${res.status} ì—ëŸ¬: ${errorText.substring(0, 200)}`);[m
[32m+               [m
[32m+               // API í‚¤ ì‚¬ìš©ëŸ‰ ê¸°ë¡ (Rate Limit í¬í•¨)[m
[32m+               apiKeyManager.recordCall(selectedKeyIndex, false, responseTime, isRateLimit);[m
[32m+               // ë™ì  ë³‘ë ¬ ì²˜ë¦¬ í†µê³„ ê¸°ë¡ (ì‹¤íŒ¨)[m
[32m+               adaptiveConcurrency.recordRequest(false, responseTime);[m
[32m+               [m
[32m++>>>>>>> e952aa8 (feat: ìë™ ìˆ˜ì§‘ ìµœì í™” ë° GitHub ìë™ ë°°í¬ ì„¤ì •)[m
                return { seed, success: false, totalCollected: 0, totalSavedOrUpdated: 0, savedCount: 0, error: `HTTP ${res.status}` };[m
              }[m
          } catch (e: any) {[m
            const error = e as Error;[m
[32m++<<<<<<< HEAD[m
[32m +          if (error.name === 'AbortError') {[m
[32m +            return { seed, success: false, totalCollected: 0, totalSavedOrUpdated: 0, savedCount: 0, error: 'Timeout' };[m
[32m++=======[m
[32m+           const responseTime = Date.now() - startTime;[m
[32m+           [m
[32m+           // API í‚¤ ì‚¬ìš©ëŸ‰ ê¸°ë¡ (ì—ëŸ¬)[m
[32m+           const selectedKeyIndex = apiKeyManager.selectBestKey();[m
[32m+           apiKeyManager.recordCall(selectedKeyIndex, false, responseTime, false);[m
[32m+           // ë™ì  ë³‘ë ¬ ì²˜ë¦¬ í†µê³„ ê¸°ë¡ (ì‹¤íŒ¨)[m
[32m+           adaptiveConcurrency.recordRequest(false, responseTime);[m
[32m+           [m
[32m+           // íƒ€ì„ì•„ì›ƒ ì—ëŸ¬ëŠ” ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ê³„ì† ì§„í–‰[m
[32m+           if (error.name === 'AbortError') {[m
[32m+             console.warn(`â±ï¸ ì‹œë“œ ì²˜ë¦¬ íƒ€ì„ì•„ì›ƒ (${seed}): 3ë¶„ ì´ˆê³¼`);[m
[32m+             return { seed, success: false, totalCollected: 0, totalSavedOrUpdated: 0, savedCount: 0, error: 'Timeout (3ë¶„ ì´ˆê³¼)' };[m
[32m+           } else if (error.message?.includes('Circuit Breaker')) {[m
[32m+             console.warn(`ğŸš¨ Circuit Breaker ì°¨ë‹¨: ${error.message}`);[m
[32m+             return { seed, success: false, totalCollected: 0, totalSavedOrUpdated: 0, savedCount: 0, error: error.message };[m
[32m++>>>>>>> e952aa8 (feat: ìë™ ìˆ˜ì§‘ ìµœì í™” ë° GitHub ìë™ ë°°í¬ ì„¤ì •)[m
            } else {[m
[31m -            console.error(`âŒ ì‹œë“œ ì²˜ë¦¬ ì‹¤íŒ¨ (${seed}):`, error.message || error);[m
[31m -            return { seed, success: false, totalCollected: 0, totalSavedOrUpdated: 0, savedCount: 0, error: error.message || 'Unknown error' };[m
[32m +            return { seed, success: false, totalCollected: 0, totalSavedOrUpdated: 0, savedCount: 0, error: error.message || 'Unknown' };[m
            }[m
          }[m
        });[m
[36m@@@ -218,9 -369,18 +381,24 @@@[m
          break; // ì²­í¬ ë£¨í”„ ì¢…ë£Œ[m
        }[m
  [m
[32m++<<<<<<< HEAD[m
[32m +      // ì²­í¬ ê°„ Rate Limit ë°©ì§€ ê°„ê²©[m
[32m +      if (chunks.indexOf(chunk) < chunks.length - 1) {[m
[32m +        await new Promise(r => setTimeout(r, 200));[m
[32m++=======[m
[32m+       // ì²­í¬ ê°„ Rate Limit ë°©ì§€ ê°„ê²© (ë™ì  ì¡°ì •)[m
[32m+       if (chunks.indexOf(chunk) < chunks.length - 1) {[m
[32m+         // ì„±ê³µë¥ ê³¼ ì‘ë‹µ ì‹œê°„ì— ë”°ë¼ ëŒ€ê¸° ì‹œê°„ ì¡°ì •[m
[32m+         const stats = adaptiveConcurrency.getStats();[m
[32m+         const delay = stats.successRate > 0.95 && stats.avgResponseTime < 2000 [m
[32m+           ? 100  // ì„±ê³µë¥  ë†’ê³  ë¹ ë¥´ë©´ ì§§ì€ ëŒ€ê¸°[m
[32m+           : stats.successRate < 0.8 || stats.avgResponseTime > 5000[m
[32m+           ? 500  // ì„±ê³µë¥  ë‚®ê±°ë‚˜ ëŠë¦¬ë©´ ê¸´ ëŒ€ê¸°[m
[32m+           : 200; // ê¸°ë³¸ ëŒ€ê¸°[m
[32m+         [m
[32m+         console.log(`â³ ì²­í¬ ê°„ ëŒ€ê¸°: ${delay}ms (ì„±ê³µë¥ : ${(stats.successRate * 100).toFixed(1)}%, ì‘ë‹µ: ${stats.avgResponseTime.toFixed(0)}ms)`);[m
[32m+         await new Promise(r => setTimeout(r, delay));[m
[32m++>>>>>>> e952aa8 (feat: ìë™ ìˆ˜ì§‘ ìµœì í™” ë° GitHub ìë™ ë°°í¬ ì„¤ì •)[m
        }[m
      }[m
  [m
